# 作業サマリー (Work Summary)

このドキュメントは、Gemini CLIとの対話セッションにおける開発作業の要約です。

## 達成した目標

ローカル環境で動作する、複数のGoogle Geminiモデルを切り替え可能なAIチャットアプリケーションの基本機能を構築しました。さらに、特定モデルに対する利用上限管理機能も実装しました。

## 実装済みの機能詳細

### 1. AIチャット基本機能
- **UI:** Next.jsとReactで構築。チャット履歴の表示とメッセージ入力が可能です。
- **AI連携:** Google Vertex AIと接続し、AIからの応答をストリーミングで表示します。
- **会話履歴:** 過去のやり取りを記憶し、文脈を理解した会話ができます。

### 2. マルチモデル選択機能
- **対応モデル:** サイドバーのドロップダウンから、以下のGeminiモデルを選択できます。
  - `gemini-1.5-flash`
  - `gemini-1.5-pro`
  - `gemini-2.5-flash`
  - `gemini-2.5-pro`
- **実装ファイル:**
  - `src/context/AppContext.tsx`: モデルリストを管理
  - `src/components/sidebar.tsx`: モデル選択のUI

### 3. `gemini-2.5-pro` 利用上���設定
- **上限:** 月額 $300
- **技術:** Firestoreデータベースを利用してコストを追跡します。
- **データベースID:** `llmplayground`
- **機能:**
  - APIリクエストの前に月の合計利用額を確認し、上限を超えている場合はエラーを返します。
  - リクエスト完了後に、使用トークン数からコストを算出し、合計額を更新します。
  - 月が変わると、合計利用額は自動的にリセットされます。
- **実装ファイル:**
  - `src/app/api/chat/route.ts`: 上限チェックとコスト計算ロジック
  - `src/services/firestore.ts`: Firestoreへの接続設定

### 4. 詳細なコスト追跡
- Firestoreのドキュメントに、月の合計利用額 (`total_cost`) に加えて、日ごとの利用額 (`daily_costs`) と最終更新日時 (`last_updated`) を記録します。
- **実装ファイル:** `src/app/api/chat/route.ts`

## 解決した技術的な問題

- **Vertex AI 404エラー:** モデルIDのバージョン (`-001`) が原因のエラーを、より汎用的な `gemini-1.5-flash` に修正して解決しました。
- **Firestore 5 NOT_FOUNDエラー:** 当初、権限不やDB未作成を疑いましたが、最終的に**特定のデータベースID (`llmplayground`) をコードで明示的に指定していなかった**ことが原因でした。`src/services/firestore.ts` を修正して解決しました。
- **ターミナル起因のセッション切断:** `Ctrl+C` やフォアグラウンドプロセスが原因でCLIセッションが終了する問題に対し、**複数のターミナルウィンドウを使い分ける**方法で対応しました。
- **Gitの誤コミット:** `.gitignore` の問題で `node_modules` をコミットしようとした問題を、`Ctrl+C` でプロセスを停止し、`git reset` でステージングを解除することで解決しました。

---

## セーブポイント (2025/07/09) 以降の追加機能

### 5. マルチAIプロバイダー対応
- **概要:** Geminiに加え、OpenAIとAnthropic (Claude) のモデルにも対応しました。
- **実装:**
  - `openai.ts` と `anthropic.ts` サービスファイルを作成。
  - `/api/chat/route.ts` を更新し、モデルIDに応じて各サービスにリクエストを振り分けるロジックを実装。
  - 各APIの仕様に合わせて、メッセージの役割名（`role`）を変換する処理を追加（例: `model` -> `assistant`）。

### 6. システムプロンプト機能
- **概要:** AIのペルソナなどを設定するためのシステムプロンプト入力機能を追加しました。
- **UI:** サイドバーに専用のテ��ストエリアを設置。
- **実装:**
  - `AppContext` で状態を管理し、APIリクエストに `systemPrompt` を含めるように変更。
  - 各AIサービスが、それぞれのAPI仕様（`systemInstruction`, `system`パラメータなど）に従ってプロンプトを処理するように修正。

### 7. 会話削除機能
- **概要:** 会話履歴をクリアするボタンを実装しました。
- **UI:** ヘッダーの右上にゴミ箱アイコンのボタンを配置。
- **実装:** ボタンクリックで `messages` 状態をリセットする `clearConversation` 関数を `AppContext` に追加。

### 8. UI/UXの改善
- モデル選択のドロップダウンリストを、プロバイダーごと（Anthropic, OpenAI, Gemini）にグループ分けしました。
- ドロップダウンの表示を、内部IDから分かりやすいモデル名に変更しました。
- デフォルトで選択されるモデルを `Claude 3.7 Sonnet` に変更しました。