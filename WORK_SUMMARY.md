'''
# 作業サマリー (Work Summary)

このドキュメントは、Gemini CLIとの対話セッションにおける開発作業の要約です。

## 達成した目標

ローカル環境で動作する、複数のGoogle Geminiモデルを切り替え可能なAIチャットアプリケーションの基本機能を構築しました。さらに、特定モデルに対する利用上限管理機能も実装しました。

## 実装済みの機能詳細

### 1. AIチャット基本機能
- **UI:** Next.jsとReactで構築。チャット履歴の表示とメッセージ入力が可能です。
- **AI連携:** Google Vertex AIと接続し、AIからの応答をストリーミングで表示します。
- **会話履歴:** 過去のやり取りを記憶し、文脈を理解した会話ができます。

### 2. マルチモデル選択機能
- **対応モデル:** サイドバーのドロップダウンから、以下のGeminiモデルを選択できます。
  - `gemini-1.5-flash`
  - `gemini-1.5-pro`
  - `gemini-2.5-flash`
  - `gemini-2.5-pro`
- **実装ファイル:**
  - `src/context/AppContext.tsx`: モデルリストを管理
  - `src/components/sidebar.tsx`: モデル選択のUI

### 3. `gemini-2.5-pro` 利��上設定
- **上限:** 月額 $300
- **技術:** Firestoreデータベースを利用してコストを追跡します。
- **データベースID:** `llmplayground`
- **機能:**
  - APIリクエストの前に月の合計利用額を確認し、上限を超えている場合はエラーを返します。
  - リクエスト完了後に、使用トークン数からコストを算出し、合計額を更新します。
  - 月が変わると、合計利用額は自動的にリセットされます。
- **実装ファイル:**
  - `src/app/api/chat/route.ts`: 上限チェックとコスト計算ロジック
  - `src/services/firestore.ts`: Firestoreへの接続設定

### 4. 詳細なコスト追跡
- Firestoreのドキュメントに、月の合計利用額 (`total_cost`) に加えて、日ごとの利用額 (`daily_costs`) と最終更新日時 (`last_updated`) を記録します。
- **実装ファイル:** `src/app/api/chat/route.ts`

## 解決した技術的な問題

- **Vertex AI 404エラー:** モデルIDのバージョン (`-001`) が原因のエラーを、より汎用的な `gemini-1.5-flash` に修正して解決しました。
- **Firestore 5 NOT_FOUNDエラー:** 当初、権限不やDB未作成を疑いましたが、最終的に**特定のデータベースID (`llmplayground`) をコードで明示的に指定していなかった**ことが原因でした。`src/services/firestore.ts` を修正して解決しました。
- **ターミナル起因のセッション切断:** `Ctrl+C` やフォアグラウンドプロセスが原因でCLIセッションが終了する問題に対し、**複数のターミナルウィンドウを使い分ける**方法で対応しました。
- **Gitの誤コミット:** `.gitignore` の問題で `node_modules` をコミットしようとした問題を、`Ctrl+C` でプロセスを停止し、`git reset` でステージングを解除することで解決しました。

---

## セーブポイント (2025/07/09) 以降の追加機能

### 5. マルチAIプロバイダー対応
- **概要:** Geminiに加え、OpenAIとAnthropic (Claude) のモデルにも対応しました。
- **実装:**
  - `openai.ts` と `anthropic.ts` サービスファイルを作成。
  - `/api/chat/route.ts` を更新し、モデルIDに応じて各サービスにリクエストを振り分けるロジックを実装。
  - 各APIの仕様に合わせて、メッセージの役割名（`role`）を変換する処理を追加（例: `model` -> `assistant`）。

### 6. システムプロンプト機能
- **概要:** AIのペルソナなどを設定するためのシステムプロンプト入力機能を追加しました。
- **UI:** サイドバーに専用のテストエリアを設置。
- **実装:**
  - `AppContext` で状態を管理し、APIリクエストに `systemPrompt` を含めるように変更。
  - 各AIサービスが、それぞれのAPI仕様（`systemInstruction`, `system`パラメータなど）に従ってプロンプトを処理するように修正。

### 7. 会話削除機能
- **概要:** 会話履歴をクリアするボタンを実装しました。
- **UI:** ヘッダーの右上にゴミ箱アイコンのボタンを配置。
- **実装:** ボタンクリックで `messages` 状態をリセットする `clearConversation` 関数を `AppContext` に追加。

### 8. UI/UXの改善
- モデル選択のドロップダウンリストを、プロバイダーごと（Anthropic, OpenAI, Gemini）にグループ分けしました。
- ドロップダウンの表示を、内部IDから分かりやすいモデル名に変更しました。
- デフォルトで選択されるモデルを `Claude 3.7 Sonnet` に変更しました。

### 9. セキュリティ強化: IP制限
- **概要:** Next.js の Middleware を利用して、許可されたIPアドレスからのアクセスのみを受け付けるようにしました。
- **実装:**
  - `src/middleware.ts` を作成し、リクエストヘッダーの `x-forwarded-for` からIPアドレスを取得。
  - 環境変数 `ALLOWED_IPS` に設定されたIPリストと照合し、一致しない場合は403エラーを返します。
  - 開発環境 (`NODE_ENV=development`) では、この制限は自動的に無効になります。

### 10. モデル追加: OpenAI GPT-4.1
- **概要:** OpenAIの新しいモデル `gpt-4.1` を選択肢に追加しました。
- **実装:** `src/context/AppContext.tsx` の `MODEL_GROUPS` に `GPT-4.1` を追加。

### 11. マルチモーダル対応基盤 (GCS連携)
- **概要:** ファイルアップロード機能を、GCP Cloud Storage (GCS) と連携する堅牢なアーキテクチャで実装しました。
- **実装:**
  - GCSへの署名付きURLを生成するAPI (`/api/generate-upload-url`) を作成。
  - フロントエンドから直接GCSへファイルをアップロードするロジックを実装。
  - 画像ファイル (`image/*`) のアップロードとチャット履歴でのプレビューに対応。

### 12. テキスト・JSONファイル抽出機能
- **概要:** TXT (`text/plain`) および JSON (`application/json`) ファイルの内容を抽出し、AIへのコンテキストとして利用する機能を追加しました。
- **実装:**
  - GCSからファイルをダウンロードし、テキストとして抽出するAPI (`/api/extract-text`) を作成。
  - 抽出したテキストをサイドバーの���用欄に表示し、プロンプトと結合してAIに送信するロジックを実装。

---

## 現在の作業: Document AI 導入による高度なファイル解析

**目標:** PDF, DOCX, XLSX ファイルの内容を、GCPの強力なサービスである **Document AI** を利用して抽出し、AIへのコンテキストとして利用する。

**実装状況 (コードレベル):**
- **完了:**
  - `@google-cloud/documentai` パッケージのインストール。
  - `/api/extract-text` APIを拡張し、Document AIを呼び出すロジックを追加済み。
  - フロントエンドのファイル選択ダイアログで、PDF, DOCX, XLSX形式を許可するように更新済み。

**保留中のタスク (ユーザー設定):**
アプリケーションを正しく動作させるには、PC再起動後に以下のGCP設定が必要です。

1.  **Document AI Processorの作成:**
    - GCPコンソールで「Document AI」にアクセスします。
    - 「Processor Gallery」から **`Document OCR`** を選択し、新しいプロセッサを作成してください。
    - リージョンは `us` (米国) または `eu` (欧州) を選択するのが一般的です。

2.  **プロセッサIDの環境変数設定:**
    - プロセッサ作成後、その「詳細」ページに表示される**プロセッサID**（例: `projects/12345/locations/us/processors/abcdef123`）をコピーします。
    - プロジェクトルートの `.env.local` ファイルを開き、以下の行を追加・保存してください。
      ```
      DOCAI_PROCESSOR_NAME="ここにコピーしたプロセッサIDを貼り付け"
      ```

3.  **IAM権限の確認:**
    - GCPコンソールの「IAMと管理」で、このアプリケーションが使用しているサービスアカウントを選択します。
    - そのサービスアカウントに **「Document AI API ユーザー」** (`roles/documentai.apiUser`) のロールが付与されていることを確認してください。もしなければ、追加してください。

**次回の作業:**
上記の設定完了後、アプリケーションを起動し、PDF, DOCX, XLSX ファイルのアップロードとテキスト抽出が正常に動作するかを確認します。
'''